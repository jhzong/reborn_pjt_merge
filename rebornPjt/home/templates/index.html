{% extends "base.html" %}
{% block css %}
<link rel='stylesheet' href="/static/css/magazine.css">
{% comment %} <link rel='stylesheet' href="/static/css/restaurants.css"> {% endcomment %}
<link rel='stylesheet' href="/static/css/home.css">
<!-- 폰트 cdn으로 임시로 적용 > 다운받지 않아서 나중에 버전오르며 적용 안 될 수 있음-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css" integrity="sha512-10/jx2EXwxxWqCLX/hHth/vu2KY3jCF70dCQB8TSgNjbCVAC/8vai53GfMDrO2Emgwccf2pJqxct9ehpzG+MTw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
/* 검색필터버튼 아이콘 */
.filter-icon-button {
    position: absolute;
    /* 버튼(검색) 너비와 간격을 고려하여 오른쪽에서 띄움 */
    /* 보통 검색 버튼의 너비가 70~80px이므로 그 앞에 위치시킵니다 */
    right: 4%; 
    top: 50%; /* 정확히 세로 중앙 */
    transform: translateY(-50%); /* 정확히 세로 중앙 */
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    z-index: 10;
    display: flex; /* 아이콘 이미지 정렬 */
    align-items: center;
}

.filter-icon-button img {
    width: 30px;
    height: 30px;
}

.filter-count {
    position: absolute;
    /*top: -5px;
    right: -5px;*/
    top: -16px;
    right: 68px;
    height: 16px;
    background-color: #007bff;;
    border-radius: 16px;
    color: #fff;
    font-weight: 700;
    font-size: 10px;
    padding: 0px 5px;
    text-align: center;
    z-index: 100;
}
.filter-count.off {
    display: none;
}
.filter-count.on>*.on {
    display: inline-block;
}
/* 검색필터버튼 아이콘 */
</style>
{% endblock css %}
{% block script %}
<script>
    //검색버튼
    function searchData() {
        let url = "/restaurants/reslist";
        location.href = url+"?"+$("#searchForm").serialize()+"&"+searchPopfrm;
    }

    document.addEventListener('DOMContentLoaded', () => {
        // 지역 슬라이드
        const sliderTrack = document.querySelector('.slider-track');
        const prevBtn = document.querySelector('.slide-btn.prev');
        const nextBtn = document.querySelector('.slide-btn.next');

        let isDragging = false;
        let startX = 0;
        let currentTranslate = 0;
        let prevTranslate = 0;
        let animationID;
        let sliderWidth = 0;
        let containerWidth = 0;
        let moved = false;

        // 초기 설정
        window.addEventListener('load', () => {
        sliderWidth = sliderTrack.scrollWidth;
        containerWidth = sliderTrack.parentElement.offsetWidth;
        });

        sliderTrack.addEventListener('mousedown', dragStart);
        sliderTrack.addEventListener('touchstart', dragMobileStart);

        sliderTrack.addEventListener('mouseup', dragEnd);
        sliderTrack.addEventListener('touchend', dragEnd);

        sliderTrack.addEventListener('mouseleave', dragEnd);

        sliderTrack.addEventListener('mousemove', dragMove);
        sliderTrack.addEventListener('touchmove', dragMobileMove);

        function dragStart(e) {
            e.preventDefault(); // PC 드래그 핵심
            isDragging = true;
            moved = false;
            startX = getPositionX(e);
            sliderTrack.classList.add('dragging');
            animationID = requestAnimationFrame(animation);
        }

        function dragMobileStart(e) {
            isDragging = true;
            moved = false;
            startX = getPositionX(e);
            sliderTrack.classList.add('dragging');
            animationID = requestAnimationFrame(animation);
        }


        function dragEnd() {
            isDragging = false;
            prevTranslate = currentTranslate;
            sliderTrack.classList.remove('dragging');
            cancelAnimationFrame(animationID);
            checkBounds();
        }

        function dragMove(e) {
            if (!isDragging) return;
            if (e.type === 'mousedown') {
                e.preventDefault(); // PC에서만
            }
            const currentPosition = getPositionX(e);
            const diff = currentPosition - startX;
            if (Math.abs(diff) > 5) {
                moved = true; // 클릭X
            }
            currentTranslate = prevTranslate + diff;
        }

        function dragMobileMove(e) {
            if (!isDragging) return;
            const currentPosition = getPositionX(e);
            const diff = currentPosition - startX;
            if (Math.abs(diff) > 5) {
                moved = true; // 클릭X
            }
            currentTranslate = prevTranslate + diff;
        }


        function getPositionX(event) {
            return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX;
        }

        function animation() {
        setSliderPosition();
            if (isDragging) requestAnimationFrame(animation);
        }

        function setSliderPosition() {
            sliderTrack.style.transform = `translateX(${currentTranslate}px)`;
        }

        // 경계 체크 (슬라이더가 너무 좌우로 움직이지 않게 제한)
        function checkBounds() {
        if (currentTranslate > 0) {
            currentTranslate = 0;
        }
        if (Math.abs(currentTranslate) > sliderWidth - containerWidth) {
            currentTranslate = -(sliderWidth - containerWidth);
        }
        prevTranslate = currentTranslate;
            setSliderPosition();
        }

        sliderTrack.addEventListener('click', function (e) {
            if (moved) {
                e.preventDefault();   // 링크 이동 막기
                e.stopPropagation();
            }
        });

        // 좌우 버튼 클릭 이벤트
        prevBtn.addEventListener('click', () => {
            currentTranslate += 165; // 한 칸씩 이동 (아이템 너비 + gap)
            if (currentTranslate > 0) currentTranslate = 0;
            prevTranslate = currentTranslate;
            setSliderPosition();
        });

        nextBtn.addEventListener('click', () => {
            currentTranslate -= 165;
            if (Math.abs(currentTranslate) > sliderWidth - containerWidth) {
                currentTranslate = -(sliderWidth - containerWidth);
            }
            prevTranslate = currentTranslate;
            setSliderPosition();
        });
    });

    let searchPopfrm = $("#searchPopFrm").serialize();  //검색필터팝업 폼 내용 저장할 변수
    $(document).ready(function() {
        //검색필터 적용
        $(document).on("click", ".btn-apply-filter", function () {
            $("#res_nm").val($("input[name='searchResNm']").val()); //메인 음식점 검색에 적용
            searchPopfrm = $("#searchPopFrm").serialize();

            count = updateFilterCount();    //10개이상인 경우 원형태가 늘어나서 이상함.
            // 아이콘 변경
            if(count==0){
                $(".filterBtnImg").attr("src", "/static/images/home/icon_filter_off.png");
            }else if(count>0) {
                $(".filterBtnImg").attr("src", "/static/images/home/icon_filter_on.png");
            }

            // 팝업 닫기
            $(".modal").hide();
            $("body").removeClass("modal-open");
        });

        //검색필터팝업 버튼 클릭
        $('#filterBtn').on('click', function(){
            searchPopfrm += "&res_nm=" + $("#res_nm").val(); // 추가 값 붙이기
            SearchFilterModal('modal-filter', 'filterBtn', searchPopfrm);
        });
    });
</script>
{% endblock script %}
{% block body %}
<div id="header_bg">
  <div class="main-header-area">
    <h1>
      <h1 class="r_logo"><i class="fa-solid fa-utensils"></i> 미식 가이드</h1>
    </h1>
    <form class="search-box" id="searchForm">
      <span class="search-icon"><img src='/static/images/magazine/search_icon.png'></span>
      <input type="text" id="res_nm" name="res_nm" placeholder="음식점 이름을 검색해보세요." />
      <a class="filter-icon-button" data-toggle="modal" data-target="#modal-filter" id="filterBtn">
        <div class="filter-count off">1</div>
        <img src="/static/images/home/icon_filter_off.png" class="filterBtnImg" alt="필터 아이콘" />
      </a>
      <button type="button" onclick="searchData();">검색</button>
    </form>
  </div>
</div>
<div class="home-container">
    <h1>어디로 갈까요?</h1>
    <div class="drag-slider">
    <button class="slide-btn prev">&lt;</button>
    <div class="slider-container">
        <div class="slider-track">
            {% for loc in locationDetail %}
            <div class="slide-item">
                <a class="slide-item" href="/restaurants/reslist?locno={{ loc.location.locno }}&locdno={{ loc.locdno }}">
                    {{ loc.locd_nm }}
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    <button type="button" class="slide-btn next">&gt;</button>
    </div>
    <h1>무엇을 먹을까요?</h1>
    <div class="food-container">
        <ul class="food-grid">
            {% for food in foodType %}
            <li>
                <a href="/restaurants/reslist?ftypeno={{ food.ftypeno }}" class="food-item">
                    <div class="food-img">
                        <img src="{{ food.img_url_main }}" alt="{{ food.ftype }}">
                    </div>
                    <span class="food-name">{{ food.ftype }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
<!-- Modal Body -->
<form id="searchPopFrm" name="searchPopFrm">
    <!-- 다른곳에서 폼안에 폼 넣어서 문제가 생길 수 있으니 바깥으로 빼둠 -->
    <div id="modal-filter" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modalTitle"></div>
</form>
{% endblock body %}